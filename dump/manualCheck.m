%% manual checks, untreated

in_auto = untreated_in;

Ninit = {[191.8	231.0	101.6; 120.8	244.3	107.4]};
Ninit{2} = [1274	367.8	160.9; 1836	321.700	139.263; 2243	356.940	154.758; 1656	398.914	160.568; 2254	338.861	149.919];
Ninit{3} = [2777.000	448.895	179.296; 3150.000	393.446	161.124; 2401.000	426.193	170.435];
Ninit{4} = [2909	422.241	177.078; 3841	360.264	153.297];
Ninit{5} = [1377	354.569	152.852; 1885	360.923	146.775; 1693	347.614	142.779; 1954	382.577	150.893; 3988	365.285	144.909];

Cinit = {[167.7	454.1	176.4; 128.2	539.8	198.4]};
Cinit{2} = [2268	760.9	260.4; 1575	691.337	231.494; 3167	735.154	246.868; 3083	881.139	278.020; 1691	680.827	230.399];
Cinit{3} = [1493.000	854.645	264.806; 1644.000	902.321	273.723; 1786.000	983.818	301.359];
Cinit{4} = [2265	739.165	245.082; 2014	904.730	285.848];
Cinit{5} = [622	735.367	240.569; 1180	779.666	259.289; 836	751.020	242.583; 1142	693.768	241.944; 2402	926.155	270.712];

Nbleach = {};
Nbleach{1} = [204.0	144.1	47.9; 106.9	139.5	43.7];
Nbleach{2} = [2639	179.8	77.1; 2492	166.354	59.648; 3507	177.779	71.874; 2186	212.386	91.409; 2756	184.753	72.969];
Nbleach{3} = [3186.000	220.509	88.115; 3238.000	205.935	75.633; 2428.000	227.070	88.350];
Nbleach{4} = [3161	212.449	85.946; 4018	197.689	73.929];
Nbleach{5} = [1649	221.480	84.024; 1991	209.437	76.988; 1789	212.287	84.970; 2087	209.208	79.393; 3856	204.831	77.850];

Cbleach = {[166.8	363.8	148.0; 125.0	422.9	166.2]};
Cbleach{2} = [2268	673.1	242.9; 1575	597.023	224.649; 3822	647.891	225.042; 3534	753.175	252.428; 1385	630.809	231.035];
Cbleach{3} = [1682.000	748.146	248.089; 1582.000	760.028	249.377; 1824.000	852.819	279.341];
Cbleach{4} = [2265	674.361	239.102; 2014	780.415	252.917];
Cbleach{5} = [754	685.341	240.751; 1180	654.341	236.501; 836	682.961	236.339; 1142	608.152	226.805; 2402	854.373	261.960];

Nfin = {[219.1	167.4	68.5; 98.9	162.4	64.4]};
Nfin{2} = [1754	236.2	102.1; 2606	211.270	94.608; 3261	233.988	104.033; 2495	275.850	127.691; 2866	233.522	103.645];
Nfin{3} = [2483.000	320.325	133.087; 3077.000	278.903	114.774; 1968.000	328.397	134.713];
Nfin{4} = [2483	303.967	130.270; 3582	270.471	113.897];
Nfin{5} = [1372	288.406	121.084; 2192	294.238	116.796; 1962	295.726	115.685; 2026	295.486	118.328; 3730	268.033	106.628];

Cfin = {[114.9	328.6	137.9; 96.3	363.6	151.1]};
Cfin{2} = [2952	595.9	222.8; 1952	565.122	214.782; 3769	610.639	225.873; 3762	727.169	250.971; 1942	571.366	205.123];
Cfin{3} = [1992.000	733.647	238.016; 1742.000	763.076	251.248; 2179.000	785.801	263.868];
Cfin{4} = [2702	695.639	244.278; 2144	755.324	266.731];
Cfin{5} = [645	692.287	232.380; 1325	693.482	236.318; 919	720.836	234.822; 828	612.778	219.391; 1546	848.695	250.191];

bg = {[301.4	146.5	49.3]};
bg{2} = [19703	157.6	52.8];
bg{3} = [22952.000	177.396	54.951];
bg{4} = [21836	176.509	56.098];
bg{5} = [9887	176.732	54.168];

% cytoplasm of unbleached cell after bleach and at tmax
ctrlbleach = {[10094.0	356.5	148.9]};
ctrlbleach{2} = [1277	844.7	268.1]; 
ctrlbleach{3} = [2568.000	914.043	291.181];
ctrlbleach{4} = [1940	808.618	259.966];
ctrlbleach{5} = [2087	713.315	242.903];

ctrlfin = {[7828.0	318.6	137.2]};
ctrlfin{2} = [2354	769.3	253.2];
ctrlfin{3} = [1790.000	864.467	278.032];
ctrlfin{4} = [2206	796.844	259.885];
ctrlfin{5} = [1558	791.987	254.445];

%% manual checks, FRAP after activin part 1

in_auto = peak_in;

Ninit = {[22818	1662.765	709.465; 18919	1586.462	693.857]};
Ninit{2} = [12883	439.415	221.323;17252	428.120	217.544];
Ninit{3} = [17793	525.170	300.502;18804	548.564	308.845];
Ninit{4} = [18339	510.169	212.572;21087	543.321	225.302];
Ninit{5} = [3028	644.663	227.610;3170	621.470	191.540;2655	638.861	199.809;3774	566.303	177.941;4717	581.835	187.244];
Ninit{6} = [3124	1374.152	476.161;4074	1365.193	500.060;3826	1558.806	532.824;4237	1272.937	488.861];

Cinit = {[21193	993.582	542.624;34692	1959.388	752.114]};
Cinit{2} = [14887	702.263	308.053;14336	591.251	266.798];
Cinit{3} = [20960	574.430	339.491;11830	462.104	281.625];
Cinit{4} = [10133	774.256	286.936;17095	815.765	291.814];
Cinit{5} = [2626	680.368	212.513;2210	730.287	204.334;1962	689.353	184.984;974	724.295	195.100;2238	733.077	230.563];
Cinit{6} = [5342	2326.445	591.749;4666	2166.641	574.414;3127	2247.012	599.471;3865	2498.144	695.707];

Nbleach = {};
Nbleach{1} = [28501	265.666	214.338;43496	269.107	217.912];
Nbleach{2} = [13824	165.446	82.706;18648	162.059	79.043];
Nbleach{3} = [23383	154.236	111.203;21381	159.213	115.194];
Nbleach{4} = [18339	182.378	52.289;21087	187.165	57.536];
Nbleach{5} = [3028	275.757	93.942;3170	259.435	88.298;2655	251.276	81.867;3774	256.426	84.821;4717	242.554	82.320];
Nbleach{6} = [3084	414.874	186.055;4470	421.393	193.806;3826	433.219	186.200;4237	383.684	170.301];

Cbleach = {[21895	643.031	419.776;34692	1424.878	662.097]};
Cbleach{2} = [14887	587.603	270.630;14336	453.961	223.320];
Cbleach{3} = [20960	487.592	303.222;11830	355.516	239.417];
Cbleach{4} = [10133	498.572	210.158;17095	520.638	216.357];
Cbleach{5} = [2626	568.056	176.015;2210	667.973	188.080;1962	615.481	173.354;974	659.888	179.361;2238	676.958	202.425];
Cbleach{6} = [5342	2095.192	564.472;4074	1365.193	500.060;3127	1981.171	548.391;3865	2153.931	654.287];

Nfin = {[21112	732.248	456.958;31762	713.977	448.972]};
Nfin{2} = [13269	311.241	169.527;17905	262.011	144.898];
Nfin{3} = [21030	267.110	190.129;18220	239.790	172.294];
Nfin{4} = [18384	261.783	120.335;20022	280.098	128.303];
Nfin{5} = [2891	431.693	143.569;3350	371.154	123.991;3033	423.551	146.713;4471	409.786	145.604;3600	413.227	135.373];
Nfin{6} = [2926	590.728	245.458;4554	593.612	264.853;3432	654.135	275.862;3609	550.731	235.099];

Cfin = {[11973	829.380	500.791;47174	1097.069	574.644]};
Cfin{2} = [11438	504.321	249.729;11362	451.044	223.695];
Cfin{3} = [14632	396.370	270.511;13673	299.362	205.858];
Cfin{4} = [12776	449.626	203.588;22787	466.223	204.735];
Cfin{5} = [2728	485.287	155.224;2184	579.276	193.629;1315	503.731	150.636;1639	525.704	147.423;1834	536.244	154.775];
Cfin{6} = [4242	1169.014	397.050;5052	1150.219	387.427;3108	1267.555	415.019;1458	1404.239	441.827];

bg = {[62203	278.341	222.838]};
bg{2} = [76523	153.878	71.621];
bg{3} = [3199	181.893	131.003];
bg{4} = [50513	187.009	64.737];
bg{5} = [6663	167.773	46.500];
bg{6} = [8447	247.603	87.190];

% cytoplasm of unbleached cell after bleach and at tmax
ctrlbleach = {[15131	1684.104	711.980]};
ctrlbleach{2} = [17928	486.230	247.696]; 
ctrlbleach{3} = [14878	627.092	348.301];
ctrlbleach{4} = [10348	611.945	234.482];
ctrlbleach{5} = [2764	657.267	239.527];
ctrlbleach{6} = [4385	1999.123	608.275];

ctrlfin = {[21656	1666.146	704.845]};
ctrlfin{2} = [15058	444.599	234.800];
ctrlfin{3} = [8849	528.282	310.737];
ctrlfin{4} = [8143	643.305	248.167];
ctrlfin{5} = [3538	588.993	193.171];
ctrlfin{6} = [3330	1517.971	461.485];

%% manual checks, FRAP after activin part 2

in_auto = adapted_in;

Ninit = {[12658	337.947	180.243;16940	364.033	192.457]};
Ninit{2} = [5966	485.708	199.275;6686	365.658	154.619];
Ninit{3} = [3879	368.746	167.548;4290	452.221	193.841;4911	433.108	187.545];
Ninit{4} = [3998	496.397	195.269;3547	367.922	151.404];
Ninit{5} = [2876	370.718	169.227;3510	328.297	150.677];
Ninit{6} = [2494	446.503	180.616;3539	405.709	189.678;3739	344.909	151.491];

Cinit = {[6017	701.876	300.749;5890	678.635	287.776]};
Cinit{2} = [2715	838.326	289.801;6177	678.913	237.502];
Cinit{3} = [3654	788.615	260.279;3626	741.574	263.368;3344	1010.296	319.225];
Cinit{4} = [4013	756.401	262.825;512	785.236	269.687];
Cinit{5} = [2250	602.608	216.842;2083	784.663	255.866];
Cinit{6} = [3568	575.770	217.563;2317	557.117	209.640;3126	649.590	229.338];

Nbleach = {};
Nbleach{1} = [12658	171.614	91.306;16940	163.919	84.556];
Nbleach{2} = [5966	218.376	94.133;6686	194.374	79.373];
Nbleach{3} = [3879	186.279	84.914;4290	204.036	94.332;4911	208.419	95.660];
Nbleach{4} = [3998	237.321	104.402;3547	221.762	90.176];
Nbleach{5} = [2876	128.300	37.290;3510	134.636	45.257];
Nbleach{6} = [2494	120.617	43.161;3539	118.143	40.276;3739	117.947	38.707];

Cbleach = {[4890	587.831	263.366;6995	596.580	271.311]};
Cbleach{2} = [2715	751.829	271.524;6177	638.461	233.090];
Cbleach{3} = [3654	739.013	257.444;3626	689.661	246.206;3344	957.818	309.818];
Cbleach{4} = [4013	676.718	241.148;512	692.916	225.466];
Cbleach{5} = [2250	382.486	166.886;2083	415.198	160.805];
Cbleach{6} = [3568	380.365	162.277;2317	379.064	160.524;3126	418.872	171.355];

Nfin = {[11158	276.702	155.998;15366	270.204	149.782]};
Nfin{2} = [5785	379.968	166.036;7032	297.907	132.475];
Nfin{3} = [3961	302.998	142.605;3853	362.772	169.372;4883	342.312	157.747];
Nfin{4} = [4434	365.748	151.614;3404	299.629	125.658];
Nfin{5} = [2825	213.419	99.060;3542	224.057	104.488];
Nfin{6} = [2629	226.172	110.531;3286	225.007	113.292;3767	201.398	100.825];

Cfin = {[5025	594.799	271.151;8275	546.508	250.431]};
Cfin{2} = [3343	728.168	252.138;7195	546.026	207.925];
Cfin{3} = [4585	673.693	244.971;3635	667.759	244.448;4475	861.868	286.927];
Cfin{4} = [3182	611.275	226.632;541	690.268	223.322];
Cfin{5} = [2567	381.220	160.323;998	508.880	201.690];
Cfin{6} = [3427	336.647	144.701;4014	342.506	148.771;1392	355.603	158.471];

bg = {[28757	147.352	69.034]};
bg{2} = [17650	165.728	54.234];
bg{3} = [19351	148.500	56.757];
bg{4} = [20321	172.500	50.976];
bg{5} = [35111	132.853	45.770];
bg{6} = [12865	118.335	48.148];

% cytoplasm of unbleached cell after bleach and at tmax
ctrlbleach = {[7053	546.120	247.812]};
ctrlbleach{2} = [4231	649.582	232.671]; 
ctrlbleach{3} = [3054	815.486	269.382];
ctrlbleach{4} = [3091	653.823	224.222];
ctrlbleach{5} = [4218	538.248	204.040];
ctrlbleach{6} = [3476	623.549	222.161];

ctrlfin = {[7999	509.895	242.815]};
ctrlfin{2} = [3757	618.065	220.393];
ctrlfin{3} = [4250	730.620	264.064];
ctrlfin{4} = [3279	596.518	215.011];
ctrlfin{5} = [4977	552.988	215.069];
ctrlfin{6} = [5137	544.384	202.491];

%%
in_man = struct('Araw',[],'ArawCyt',[],'Acorr',[],'AcorrCyt',[]);

for i = 1:numel(bg)
    %vidx = [2 1];

    disp('----')

    bgval = min(cat(1, bg{i}(:,2), Nbleach{i}(:,2)));
    BF = mean((ctrlfin{i}(:,2) - bgval)./(ctrlbleach{i}(:,2) - bgval));

    R = (Ninit{i}(:,2) - bgval)./(Cinit{i}(:,2) - bgval);
    Rp = (Nfin{i}(:,2) - bgval)./(Cfin{i}(:,2) - bgval); % no BF there: it drops out
    Rrat = Rp./R;

    %disp('Rrat')
    %disp([Rrat allOut{1}.Rrat(vidx)]);

    nb = (Nbleach{i}(:,2) - bgval)./(Ninit{i}(:,2) - bgval);
    nc = (Cbleach{i}(:,2) - bgval)./(Cinit{i}(:,2) - bgval);
    corrfac = nc - nb;

    Araw = ((Nfin{i}(:,2)-bgval)/BF + bgval - Nbleach{i}(:,2))./(Ninit{i}(:,2) - bgval);
    %Araw = BF*((Nfin{i}(:,2)-bgval)/BF + bgval - Nbleach{i}(:,2))./(Ninit{i}(:,2) - bgval);
    ArawCyt = (Cbleach{i}(:,2) - (Cfin{i}(:,2)-bgval)/BF -bgval)./(Cinit{i}(:,2) - bgval);

    Acorr = Araw./corrfac; 
    %disp('Acorr');
    %disp([Acorr allOut{1}.Acorr(vidx)]);

    AcorrCyt = ArawCyt./corrfac; 

    in_man.Araw = cat(1, in_man.Araw, Araw);
    in_man.ArawCyt = cat(1, in_man.ArawCyt, ArawCyt);
    in_man.Acorr = cat(1, in_man.Acorr, Acorr);
    in_man.AcorrCyt = cat(1, in_man.AcorrCyt, AcorrCyt);
    
    %disp('AcorrCyt');
    %disp([AcorrCyt allOut{1}.AcorrCyt(vidx)]);

    %Ninitval = [Ninit{i}(:,2) allOut{1}.Ninit(vidx)];
    %Nfinval = [Nfin{i}(:,2) allOut{1}.Nfin(vidx)];
    %Cinitval = [Cinit{i}(:,2) allOut{1}.Cinit(vidx)];
    %Cfinval = [Cfin{i}(:,2) allOut{1}.Cfin(vidx)];
end

%untreated_in;
name = {'Araw','ArawCyt','Acorr','AcorrCyt'};
clf
hold on
for i = 1:4
    scatter(i + 0*in_auto.(name{i}), in_auto.(name{i}),'b')
    scatter(i - 0.5 + 0*in_man.(name{i}), in_man.(name{i}),'r')
end
hold off
xlim([-0.5 4.5]);

